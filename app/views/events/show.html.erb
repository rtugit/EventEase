<main class="event-show">
  <!-- Back Button -->
  <div class="event-back-nav">
    <%= link_to events_path, class: "back-arrow" do %>
      <i class="fa-solid fa-chevron-left"></i>
    <% end %>

    <% if user_signed_in? && @event.organizer == current_user %>
      <div class="event-owner-actions">
        <%= link_to edit_event_path(@event), class: "owner-action-btn edit-btn" do %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Edit
        <% end %>
        <%= link_to check_in_event_path(@event), class: "owner-action-btn checkin-btn" do %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          Check-in
        <% end %>
        <%= button_to event_path(@event),
                    method: :delete,
                    class: "owner-action-btn delete-btn",
                    form: {
                      data: {
                        confirm: "Are you sure you want to delete this event? This action cannot be undone."
                      }
                    } do %>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete
        <% end %>
      </div>
    <% end %>

    <button type="button"
            class="owner-action-btn share-btn"
            data-controller="share-event"
            data-share-event-url-value="<%= event_url(@event) %>"
            data-action="click->share-event#copy">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"></path>
        <path d="M12 16V4m0 0l-5 5m5-5 5 5"></path>
      </svg>
      <span data-share-event-target="label">Share Event</span>
    </button>
  </div>

  <!-- Main Event Image Section -->
  <section class="event-image-section">
    <% if @event.photos.attached? %>
      <div class="event-image-container">
        <%# Use responsive_image helper to handle Cloudinary/ActiveStorage separation %>
        <%= responsive_image(@event, :photos, alt: @event.title, class: "event-image", height: 600, width: 1200, crop: :fill) %>

        <!-- Overlay Card -->
        <div class="event-overlay-card">
          <div class="event-date-badge">
            <span class="event-day"><%= @event.starts_at&.strftime("%d") %></span>
            <span class="event-month"><%= @event.starts_at&.strftime("%b") %></span>
          </div>
          <div class="event-overlay-content">
            <h1 class="event-title-overlay"><%= @event.title %></h1>
            <p class="event-location-overlay">
              <svg class="location-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <%= @event.location %>
            </p>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Fallback if no image -->
      <div class="event-image-container event-image-placeholder">
        <div class="event-overlay-card">
          <div class="event-date-badge">
            <span class="event-day"><%= @event.starts_at&.strftime("%d") %></span>
            <span class="event-month"><%= @event.starts_at&.strftime("%b") %></span>
          </div>
          <div class="event-overlay-content">
            <h1 class="event-title-overlay"><%= @event.title %></h1>
            <p class="event-location-overlay">
              <svg class="location-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <%= @event.location %>
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </section>

  <!-- Main Content Container -->
  <div class="event-content-container">
    <!-- Event Info Section (below image) -->
    <header class="event-info-header">
      <div class="event-title-wrapper">
        <h1 class="event-title-main"><%= @event.title %></h1>
        <% if @event.category.present? %>
          <span class="event-category-badge"><%= @event.category %></span>
        <% end %>
      </div>
      <!-- Date and Time Line -->
      <p class="event-datetime-main">
        <svg class="datetime-icon" width="16" height="16" viewBox="0 2 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <% if @event.starts_at.present? %>
          <%= @event.starts_at.strftime("%d.%m.%Y") %>
          <% if @event.ends_at.present? && @event.ends_at.to_date != @event.starts_at.to_date %>
            - <%= @event.ends_at.strftime("%d.%m.%Y") %>
          <% end %>
          <span class="datetime-separator"> <i class="fa-regular fa-clock"></i> </span>
          <%= @event.starts_at.strftime("%H:%M") %>
          <% if @event.ends_at.present? %>
            - <%= @event.ends_at.strftime("%H:%M") %>
          <% end %>
        <% end %>
      </p>
      <p class="event-location-main">
        <svg class="location-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <%= @event.location %>
      </p>
      <div class="event-joined-count">
        <div class="attendee-avatars">
          <% @event.registrations.limit(3).each do |reg| %>
            <div class="attendee-avatar" title="<%= reg.name.presence || reg.email %>">
              <%= render_avatar(reg, size: 32) %>
            </div>
          <% end %>
          <% if @event.registrations.count > 3 %>
            <div class="attendee-avatar attendee-more">+<%= @event.registrations.count - 3 %></div>
          <% end %>
        </div>
        <span class="joined-text">
          <%= @event.registrations.count %>+ People are joined
        </span>
      </div>
    </header>

    <!-- Tabs Section -->
    <section class="event-tabs-section" data-controller="tabs">
      <div class="tabs-header" role="tablist">
        <button type="button"
                class="tab-button active"
                role="tab"
                aria-selected="true"
                aria-controls="details-panel"
                id="details-tab"
                data-tabs-target="tab"
                data-action="click->tabs#switchTab"
                data-tab="details">
          Details
        </button>
        <button type="button"
                class="tab-button"
                role="tab"
                aria-selected="false"
                aria-controls="guests-panel"
                id="guests-tab"
                data-tabs-target="tab"
                data-action="click->tabs#switchTab"
                data-tab="guests">
          Guests
        </button>
        <button type="button"
                class="tab-button"
                role="tab"
                aria-selected="false"
                aria-controls="comments-panel"
                id="comments-tab"
                data-tabs-target="tab"
                data-action="click->tabs#switchTab"
                data-tab="comments">
          Comments
        </button>
      </div>

      <!-- Tab Panels -->
      <div class="tabs-content">
        <!-- Details Panel -->
        <div id="details-panel"
            class="tab-panel active"
            role="tabpanel"
            aria-labelledby="details-tab"
            data-tabs-target="panel"
            data-panel="details">
          <div class="event-description">
            <p class="description-text"><%= simple_format(@event.description) %></p>
          </div>

          <% if @event.rundown_items.any? %>
            <div class="event-rundown">
              <h2 class="section-title">Rundown</h2>
              <div class="rundown-list" data-controller="rundown-collapse">
                <% @event.rundown_items.ordered.each do |item| %>
                  <div class="rundown-item-collapsible" data-rundown-collapse-target="item">
                    <button type="button"
                            class="rundown-item-header"
                            data-action="click->rundown-collapse#toggle"
                            data-rundown-collapse-target="header">
                      <span class="rundown-item-title"><%= item.heading %></span>
                      <svg class="rundown-arrow"
                          width="20"
                          height="20"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          data-rundown-collapse-target="arrow">
                        <path d="M6 9l6 6 6-6"/>
                      </svg>
                    </button>
                    <div class="rundown-item-content" data-rundown-collapse-target="content">
                      <p class="rundown-description"><%= simple_format(item.description) %></p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Location Map Section (only in Details tab) -->
          <div class="location-map-section">
            <h2 class="section-title">Location</h2>

            <p class="rundown-item-title" style="margin-bottom: 12px;">
              <%= @event.location %>
            </p>

            <div id="event-map"
                class="map-container"
                data-location="<%= @event.location %>"
                style="height: 260px; border-radius: 16px; overflow: hidden;">
              <noscript>
                <p><%= @event.location %></p>
              </noscript>
            </div>
          </div>
        </div>

        <!-- Guests Panel -->
        <div id="guests-panel"
            class="tab-panel"
            role="tabpanel"
            aria-labelledby="guests-tab"
            data-tabs-target="panel"
            data-panel="guests">
          <div class="guests-content">
            <h2 class="section-title">Guests</h2>
            <% active_registrations = @event.registrations.where.not(status: 'cancelled') %>
            <% if active_registrations.any? %>
              <ul class="guests-list">
                <% active_registrations.each do |registration| %>
                  <li class="guest-item">
                    <div class="guest-avatar" style="margin-right: 12px;">
                      <%= render_avatar(registration, size: 40) %>
                    </div>
                    <div class="guest-info">
                      <strong class="guest-name"><%= registration.name.presence || registration.email %></strong>
                    </div>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p class="empty-state">No guests registered yet.</p>
            <% end %>
          </div>
        </div>

        <!-- Comments Panel -->
        <div id="comments-panel"
            class="tab-panel"
            role="tabpanel"
            aria-labelledby="comments-tab"
            data-tabs-target="panel"
            data-panel="comments">
          <div class="comments-content">
            <h2 class="section-title">Comments</h2>

            <% if user_signed_in? %>
              <!-- Comment Form -->
              <div class="comment-form-container">
                <%= form_with(model: [@event, @event.comments.build],
                              url: event_comments_path(@event),
                              local: true,
                              class: "comment-form") do |form| %>
                  <div class="form-group">
                    <div class="comment-input-wrapper">
                      <div class="comment-avatar">
                        <%= render_avatar(current_user, size: 40) %>
                      </div>
                      <%= form.text_area :content,
                                        class: "form-control comment-textarea",
                                        rows: 3,
                                        placeholder: "Write a comment or ask a question...",
                                        maxlength: 1000,
                                        required: true %>
                    </div>
                  </div>
                  <div class="comment-form-actions">
                    <%= form.submit "Post Comment", class: "btn-submit-comment" %>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="comment-notice">
                <%= link_to "Sign in", new_user_session_path %> to leave a comment.
              </p>
            <% end %>

            <!-- Comments List -->
            <% if @event.comments.any? %>
              <div class="comments-list">
                <% @event.comments.recent.each do |comment| %>
                  <div class="comment-item" id="comment-<%= comment.id %>">
                    <div class="comment-header">
                      <div class="comment-avatar">
                        <%= render_avatar(comment.user, size: 40) %>
                      </div>
                      <div class="comment-meta">
                        <strong class="comment-author"><%= comment.user.full_name %></strong>
                        <span class="comment-date"><%= time_ago_in_words(comment.created_at) %> ago</span>
                      </div>
                      <% if user_signed_in? && comment.user == current_user %>
                        <div class="comment-actions">
                          <%= button_to event_comment_path(@event, comment),
                                        method: :delete,
                                        class: "btn-delete-comment",
                                        form: {
                                          data: {
                                            confirm: "Are you sure you want to delete this comment?"
                                          }
                                        } do %>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                    <div class="comment-body">
                      <p class="comment-text"><%= simple_format(comment.content) %></p>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="empty-state">No comments yet. Be the first to start the conversation!</p>
            <% end %>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Join/Unjoin Button (sticky at bottom) -->
  <div class="join-button-container">
    <% if user_signed_in? %>
      <% if @user_registration %>
        <%= button_to "Unjoin",
                    event_registration_path(@event, @user_registration),
                    method: :delete,
                    class: "btn-join-event btn-unjoin-event",
                    form: {
                      class: "unjoin-form",
                      data: {
                        controller: "registration",
                        action: "submit->registration#disable"
                      }
                    },
                    data: { registration_target: "submitButton" } %>
      <% else %>
        <%= form_with(model: [@event, @event.registrations.build],
                    url: event_registrations_path(@event),
                    method: :post,
                    local: true,
                    class: "join-form",
                    data: { controller: "registration", action: "submit->registration#disable" }) do |form| %>
          <%= form.hidden_field :email, value: current_user.email %>
          <%= form.hidden_field :name, value: "#{current_user.first_name} #{current_user.last_name}".strip %>
          <%= form.submit "Join", class: "btn-join-event", data: { registration_target: "submitButton" } %>
        <% end %>
      <% end %>
    <% else %>
      <%= link_to "Join", new_user_session_path, class: "btn-join-event" %>
    <% end %>
  </div>
</main>

<script>
  (function() {
    const initLeafletMap = async () => {
      const el = document.getElementById("event-map");
      if (!el) return;

      if (!window.L) return;

      if (el.dataset.leafletInitialized === "true") return;
      el.dataset.leafletInitialized = "true";

      const location = el.dataset.location;
      if (!location) return;

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`;

      let lat = null, lon = null;
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          lat = parseFloat(data[0].lat);
          lon = parseFloat(data[0].lon);
        }
      } catch (_) {
      }

      if (!lat || !lon) {
        lat = 51.1657;
        lon = 10.4515;
      }

      const map = L.map("event-map", { scrollWheelZoom: false }).setView([lat, lon], lat === 51.1657 ? 5 : 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      if (!(lat === 51.1657 && lon === 10.4515)) {
        L.marker([lat, lon]).addTo(map).bindPopup(location);
      }

      const detailsTab = document.getElementById("details-tab");
      if (detailsTab) {
        detailsTab.addEventListener("click", () => {
          setTimeout(() => map.invalidateSize(), 150);
        });
      }
    };

    document.addEventListener("DOMContentLoaded", initLeafletMap);
    document.addEventListener("turbo:load", initLeafletMap);
  })();
</script>
