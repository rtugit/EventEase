<main class="event-show">
  <!-- Navigation Header -->
  <nav class="event-nav-header">
    <%= link_to events_path, class: "nav-back-button" do %>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    <% end %>
    <h1 class="nav-title">Event Details</h1>
    <% if user_signed_in? && @event.organizer == current_user %>
      <div class="nav-actions">
        <%= link_to edit_event_path(@event), class: "nav-action-button nav-edit-button" do %>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          <span>Edit</span>
        <% end %>
        <%= link_to check_in_event_path(@event), class: "nav-action-button nav-edit-button" do %>
          <span>Check-in</span>
        <% end %>
        <%= button_to event_path(@event),
                    method: :delete,
                    class: "nav-action-button nav-delete-button",
                    form: {
                      data: {
                        confirm: "Are you sure you want to delete this event? This action cannot be undone."
                      }
                    } do %>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          <span>Delete</span>
        <% end %>
      </div>
    <% else %>
      <button type="button" class="nav-menu-button" aria-label="More options">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="1"/>
          <circle cx="12" cy="5" r="1"/>
          <circle cx="12" cy="19" r="1"/>
        </svg>
      </button>
    <% end %>
  </nav>

  <!-- Main Event Image Section -->
  <section class="event-image-section">
    <% if @event.photos.attached? %>
      <div class="event-image-container">
        <%# Use responsive_image helper to handle Cloudinary/ActiveStorage separation %>
        <%= responsive_image(@event, :photos, alt: @event.title, class: "event-image") %>
        <%= cl_image_tag @event.photos.first.key,
                        height: 600,
                        width: 1200,
                        crop: :fill,
                        class: "event-image",
                        alt: @event.title %>
        <!-- Overlay Card -->
        <div class="event-overlay-card">
          <div class="event-date-badge">
            <span class="event-day"><%= @event.starts_at&.strftime("%d") %></span>
            <span class="event-month"><%= @event.starts_at&.strftime("%b") %></span>
          </div>
          <div class="event-overlay-content">
            <h1 class="event-title-overlay"><%= @event.title %></h1>
            <p class="event-location-overlay">
              <svg class="location-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <%= @event.location %>
            </p>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Fallback if no image -->
      <div class="event-image-container event-image-placeholder">
        <div class="event-overlay-card">
          <div class="event-date-badge">
            <span class="event-day"><%= @event.starts_at&.strftime("%d") %></span>
            <span class="event-month"><%= @event.starts_at&.strftime("%b") %></span>
          </div>
          <div class="event-overlay-content">
            <h1 class="event-title-overlay"><%= @event.title %></h1>
            <p class="event-location-overlay">
              <svg class="location-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <%= @event.location %>
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </section>

  <!-- Main Content Container -->
  <div class="event-content-container">
    <!-- Event Info Section (below image) -->
    <header class="event-info-header">
      <div class="event-title-wrapper">
        <h1 class="event-title-main"><%= @event.title %></h1>
        <% if @event.category.present? %>
          <span class="event-category-badge"><%= @event.category %></span>
        <% end %>
      </div>
      <p class="event-location-main">
        <svg class="location-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <%= @event.location %>
      </p>
      <div class="event-joined-count">
        <div class="attendee-avatars">
          <% @event.registrations.limit(3).each do |reg| %>
            <div class="attendee-avatar" title="<%= reg.name.presence || reg.email %>">
              <%= (reg.name.presence || reg.email).first.upcase %>
            </div>
          <% end %>
          <% if @event.registrations.count > 3 %>
            <div class="attendee-avatar attendee-more">+<%= @event.registrations.count - 3 %></div>
          <% end %>
        </div>
        <span class="joined-text">
          <%= @event.registrations.count %>+ People are joined
        </span>
      </div>
    </header>

    <!-- Tabs Section -->
    <section class="event-tabs-section" data-controller="tabs">
      <div class="tabs-header" role="tablist">
        <button type="button"
                class="tab-button active"
                role="tab"
                aria-selected="true"
                aria-controls="details-panel"
                id="details-tab"
                data-tabs-target="tab"
                data-action="click->tabs#switchTab"
                data-tab="details">
          Details
        </button>
        <button type="button"
                class="tab-button"
                role="tab"
                aria-selected="false"
                aria-controls="guests-panel"
                id="guests-tab"
                data-tabs-target="tab"
                data-action="click->tabs#switchTab"
                data-tab="guests">
          Guests
        </button>
        <button type="button"
                class="tab-button"
                role="tab"
                aria-selected="false"
                aria-controls="reviews-panel"
                id="reviews-tab"
                data-tabs-target="tab"
                data-action="click->tabs#switchTab"
                data-tab="reviews">
          Reviews
        </button>
      </div>

      <!-- Tab Panels -->
      <div class="tabs-content">
        <!-- Details Panel -->
        <div id="details-panel"
            class="tab-panel active"
            role="tabpanel"
            aria-labelledby="details-tab"
            data-tabs-target="panel"
            data-panel="details">
          <div class="event-description">
            <p class="description-text"><%= simple_format(@event.description) %></p>
          </div>

          <% if @event.rundown_items.any? %>
            <div class="event-rundown">
              <h2 class="section-title">Rundown</h2>
              <div class="rundown-list" data-controller="rundown-collapse">
                <% @event.rundown_items.ordered.each do |item| %>
                  <div class="rundown-item-collapsible" data-rundown-collapse-target="item">
                    <button type="button"
                            class="rundown-item-header"
                            data-action="click->rundown-collapse#toggle"
                            data-rundown-collapse-target="header">
                      <span class="rundown-item-title"><%= item.heading %></span>
                      <svg class="rundown-arrow"
                          width="20"
                          height="20"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          data-rundown-collapse-target="arrow">
                        <path d="M6 9l6 6 6-6"/>
                      </svg>
                    </button>
                    <div class="rundown-item-content" data-rundown-collapse-target="content">
                      <p class="rundown-description"><%= simple_format(item.description) %></p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Location Map Section (only in Details tab) -->
          <div class="location-map-section">
            <h2 class="section-title">Location</h2>

            <%# Leaflet map container. Location is geocoded via Nominatim in the script below. %>
            <div id="event-map"
                 class="map-container"
                 data-location="<%= @event.location %>"
                 style="height: 260px; border-radius: 16px; overflow: hidden;">
              <noscript>
                <p><%= @event.location %></p>
              </noscript>
            </div>

            <p class="map-location-text" style="margin-top: 10px;">
              <%= @event.location %>
            </p>
          </div>
        </div>

        <!-- Guests Panel -->
        <div id="guests-panel"
            class="tab-panel"
            role="tabpanel"
            aria-labelledby="guests-tab"
            data-tabs-target="panel"
            data-panel="guests">
          <div class="guests-content">
            <h2 class="section-title">Guests</h2>
            <% if @event.registrations.any? %>
              <ul class="guests-list">
                <% @event.registrations.each do |registration| %>
                  <li class="guest-item">
                    <div class="guest-info">
                      <strong class="guest-name"><%= registration.name.presence || registration.email %></strong>
                      <span class="guest-email">(<%= registration.email %>)</span>
                    </div>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p class="empty-state">No guests registered yet.</p>
            <% end %>
          </div>
        </div>

        <!-- Reviews Panel -->
        <div id="reviews-panel"
            class="tab-panel"
            role="tabpanel"
            aria-labelledby="reviews-tab"
            data-tabs-target="panel"
            data-panel="reviews">
          <div class="reviews-content">
            <h2 class="section-title">Reviews</h2>

            <% if @event.past? && user_signed_in? %>
              <% if @user_registration && !@user_registration.reviewed? %>
                <!-- Review Form -->
                <div class="review-form-container">
                  <%= form_with(model: [@event, @event.reviews.build],
                                url: event_reviews_path(@event),
                                local: true,
                                class: "review-form") do |form| %>
                    <div class="form-group">
                      <%= form.label :rating, "Rating", class: "form-label" %>
                      <div class="rating-input">
                        <% (1..5).each do |rating| %>
                          <label class="rating-option">
                            <%= form.radio_button :rating, rating, required: true %>
                            <span class="rating-star">★</span>
                          </label>
                        <% end %>
                      </div>
                    </div>

                    <div class="form-group">
                      <%= form.label :comment, "Your Review", class: "form-label" %>
                      <%= form.text_area :comment,
                                        class: "form-control",
                                        rows: 4,
                                        placeholder: "Share your experience at this event...",
                                        maxlength: 1000 %>
                    </div>

                    <%= form.submit "Submit Review", class: "btn-submit-review" %>
                  <% end %>
                </div>
              <% elsif @user_registration && @user_registration.reviewed? %>
                <% user_review = @user_registration.review %>
                <% if user_review %>
                  <div class="review-form-container">
                    <p class="review-notice">You have already reviewed this event. You can edit or delete your review below.</p>
                    <div class="review-edit-form" data-controller="review-edit">
                      <div class="review-item" data-review-edit-target="display">
                        <div class="review-header">
                          <div class="reviewer-info">
                            <strong class="reviewer-name">Your Review</strong>
                            <div class="review-rating">
                              <% user_review.rating.times do %>
                                <span class="star-filled">★</span>
                              <% end %>
                              <% (5 - user_review.rating).times do %>
                                <span class="star-empty">★</span>
                              <% end %>
                            </div>
                          </div>
                          <div class="review-actions">
                            <button type="button"
                                    class="btn-edit-review"
                                    data-action="click->review-edit#showEdit">
                              Edit
                            </button>
                            <%= button_to "Delete",
                                        event_review_path(@event, user_review),
                                        method: :delete,
                                        class: "btn-delete-review",
                                        form: {
                                          data: {
                                            confirm: "Are you sure you want to delete your review?"
                                          }
                                        } %>
                          </div>
                        </div>
                        <% if user_review.comment.present? %>
                          <p class="review-comment"><%= simple_format(user_review.comment) %></p>
                        <% end %>
                      </div>

                      <div class="review-edit-form-content" data-review-edit-target="editForm" style="display: none;">
                        <%= form_with(model: [@event, user_review],
                                    url: event_review_path(@event, user_review),
                                    method: :patch,
                                    local: true,
                                    class: "review-form") do |form| %>
                          <div class="form-group">
                            <%= form.label :rating, "Rating", class: "form-label" %>
                            <div class="rating-input">
                              <% (1..5).each do |rating| %>
                                <label class="rating-option">
                                  <%= form.radio_button :rating, rating, required: true, checked: (user_review.rating == rating) %>
                                  <span class="rating-star">★</span>
                                </label>
                              <% end %>
                            </div>
                          </div>

                          <div class="form-group">
                            <%= form.label :comment, "Your Review", class: "form-label" %>
                            <%= form.text_area :comment,
                                              class: "form-control",
                                              rows: 4,
                                              placeholder: "Share your experience at this event...",
                                              maxlength: 1000,
                                              value: user_review.comment %>
                          </div>

                          <div class="review-form-actions">
                            <%= form.submit "Update Review", class: "btn-submit-review" %>
                            <button type="button"
                                    class="btn-cancel-edit"
                                    data-action="click->review-edit#hideEdit">
                              Cancel
                            </button>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% elsif !@user_registration %>
                <p class="review-notice">You must join the event before you can review it.</p>
              <% end %>
            <% elsif !@event.past? %>
              <p class="review-notice">Reviews are available after the event has ended.</p>
            <% end %>

            <!-- Reviews List -->
            <% if @event.reviews.any? %>
              <div class="reviews-list">
                <% @event.reviews.recent.each do |review| %>
                  <% is_own_review = user_signed_in? && review.registration.email == current_user.email %>
                  <% next if is_own_review %>
                  <div class="review-item">
                    <div class="review-header">
                      <div class="reviewer-info">
                        <strong class="reviewer-name"><%= review.registration.name.presence || review.registration.email %></strong>
                        <div class="review-rating">
                          <% review.rating.times do %>
                            <span class="star-filled">★</span>
                          <% end %>
                          <% (5 - review.rating).times do %>
                            <span class="star-empty">★</span>
                          <% end %>
                        </div>
                      </div>
                      <span class="review-date"><%= review.created_at.strftime("%B %d, %Y") %></span>
                    </div>
                    <% if review.comment.present? %>
                      <p class="review-comment"><%= simple_format(review.comment) %></p>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p class="empty-state">No reviews yet. Be the first to review this event!</p>
            <% end %>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Join/Unjoin Button (sticky at bottom) -->
  <div class="join-button-container">
    <% if user_signed_in? %>
      <% if @user_registration %>
        <!-- User has joined - show Unjoin button -->
        <%= button_to "Unjoin",
                    event_registration_path(@event, @user_registration),
                    method: :delete,
                    class: "btn-join-event btn-unjoin-event",
                    form: {
                      class: "unjoin-form",
                      data: {
                        controller: "registration",
                        action: "submit->registration#disable"
                      }
                    },
                    data: { registration_target: "submitButton" } %>
      <% else %>
        <!-- User hasn't joined - show Join button -->
        <%= form_with(model: [@event, @event.registrations.build],
                    url: event_registrations_path(@event),
                    method: :post,
                    local: true,
                    class: "join-form",
                    data: { controller: "registration", action: "submit->registration#disable" }) do |form| %>
          <%= form.hidden_field :email, value: current_user.email %>
          <%= form.hidden_field :name, value: "#{current_user.first_name} #{current_user.last_name}".strip %>
          <%= form.submit "Join", class: "btn-join-event", data: { registration_target: "submitButton" } %>
        <% end %>
      <% end %>
    <% else %>
      <%= link_to "Join", new_user_session_path, class: "btn-join-event" %>
    <% end %>
  </div>
</main>

<script>
  (function() {
    const initLeafletMap = async () => {
      const el = document.getElementById("event-map");
      if (!el) return;

      // If Leaflet isn't loaded yet, do nothing (prevents runtime error).
      if (!window.L) return;

      // Avoid double init (Turbo / repeated visits)
      if (el.dataset.leafletInitialized === "true") return;
      el.dataset.leafletInitialized = "true";

      const location = el.dataset.location;
      if (!location) return;

      // Geocode via Nominatim (no key). Keep it lightweight.
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`;

      let lat = null, lon = null;
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          lat = parseFloat(data[0].lat);
          lon = parseFloat(data[0].lon);
        }
      } catch (_) {
        // fall back
      }

      // Fallback: Germany center (so map doesn't stay blank)
      if (!lat || !lon) {
        lat = 51.1657;
        lon = 10.4515;
      }

      const map = L.map("event-map", { scrollWheelZoom: false }).setView([lat, lon], lat === 51.1657 ? 5 : 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      // Only add marker if we actually geocoded a specific place
      if (!(lat === 51.1657 && lon === 10.4515)) {
        L.marker([lat, lon]).addTo(map).bindPopup(location);
      }

      // When switching tabs back to Details, Leaflet sometimes needs a resize nudge.
      const detailsTab = document.getElementById("details-tab");
      if (detailsTab) {
        detailsTab.addEventListener("click", () => {
          setTimeout(() => map.invalidateSize(), 150);
        });
      }
    };

    document.addEventListener("DOMContentLoaded", initLeafletMap);
    document.addEventListener("turbo:load", initLeafletMap);
  })();
</script>
